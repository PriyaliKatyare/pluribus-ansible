#L3 VRRP OSPF with third party spines
---


- name: Configure L3 VRRP OSPF with third party spines
  hosts: leaf[0]

  vars_files:
  - cli_vault.yml

  tasks:
    # This task is to configure VRRP for Layer 3 fabric.
    # It takes required VRRP config data from csv file.
    # It uses pn_l3_vrrp_third_party.py module from library/ directory.
    # pn_cliusername and pn_clipassword comes from vars file - cli_vault.yml
    - name: Configure L3 vrrp
      pn_l3_vrrp_third_party:
        pn_cliusername: "{{ USERNAME }}"        # Cli username (value comes from cli_vault.yml).
        pn_clipassword: "{{ PASSWORD }}"        # Cli password (value comes from cli_vault.yml).
        pn_leaf_list: "{{ groups['leaf'] }}"    # List of all leaf switches mentioned under [leaf] grp in hosts file.
        pn_csv_data: "{{ lookup('file', '{{ csv_file }}') }}"  # Csv file containing L3 vrrp data.
      register: vrrp_out                        # Variable to hold/register output of the above tasks.
      until:  vrrp_out.failed != true           # If error pops up it will retry the code
      retries: 3                                # This is the retries count
      delay: 1

    - pause:
        seconds: 2                              # Pause playbook execution for specified amount of time.


    # This task is to configure ZTP for layer3 fabric.
    # It uses pn_l3_ztp_third_party.py module from library/ directory.
    # pn_cliusername and pn_clipassword comes from vars file - cli_vault.yml
    # If the tasks fails then it will retry as specified by retries count.
    - name: Auto configure link IPs
      pn_l3_ztp_third_party:
        pn_cliusername: "{{ USERNAME }}"                # Cli username (value comes from cli_vault.yml).
        pn_clipassword: "{{ PASSWORD }}"                # Cli password (value comes from cli_vault.yml).
        pn_spine_list: "{{ groups['third_party_spine'] }}"   # List of all third party spine switches mentioned under [third_party_spine] grp in hosts file.
        pn_leaf_list: "{{ groups['leaf'] }}"            # List of all leaf switches mentioned under [leaf] grp in hosts file.
        pn_net_address: "{{ pn_net_address }}"          # Network address required to calculate link IPs for layer3 fabric.
        pn_cidr: "{{ pn_cidr }}"                        # Subnet mask required to calculate link IPs for layer3 fabric.
        pn_supernet: "{{ pn_supernet }}"                # Supernet mask required to calculate link IPs for layer3 fabric.
        pn_loopback_ip: "{{ pn_loopback_ip }}"          # Loopback ip starting value for vrouters. Default: 109.109.109.0/24.
        pn_bfd: "{{ pn_bfd }}"                          # Flag to indicate if BFD config should be added to vrouter interfaces. Default: False.
        pn_bfd_min_rx: "{{ pn_bfd_min_rx }}"            # BFD-MIN-RX value required for adding BFD configuration to vrouter interfaces.
        pn_bfd_multiplier: "{{ pn_bfd_multiplier }}"    # BFD_MULTIPLIER value required for adding BFD configuration to vrouter interfaces.
        pn_update_fabric_to_inband: "{{ pn_update_fabric_to_inband }}"  # Flag to indicate if fabric network should be updated to in-band. Default: False.
        pn_stp: "{{ pn_stp }}"                          # Flag to enable STP (spanning tree protocol). Default: False.
      register: ztp_l3_out                              # Variable to hold/register output of the above tasks.
      until:  ztp_l3_out.failed != true                 # If error pops up it will retry the code
      retries: 3                                        # This is the retries count
      delay: 1

    - pause:
        seconds: 2                                      # Pause playbook execution for specified amount of time.

    # This task is to configure OSPF.
    # It uses pn_ebgp_ospf_third_party.py module from library/ directory.
    # pn_cliusername and pn_clipassword comes from vars file - cli_vault.yml
    - name: Configure OSPF
      pn_ebgp_ospf_third_party:
        pn_cliusername: "{{ USERNAME }}"                   # Cli username (value comes from cli_vault.yml).
        pn_clipassword: "{{ PASSWORD }}"                   # Cli password (value comes from cli_vault.yml).
        pn_leaf_list: "{{ groups['leaf'] }}"               # List of all leaf switches mentioned under [leaf] grp in hosts file.
        pn_bfd: "{{ pn_bfd }}"                             # Indicate if BFD config should be added to eBGP. Default: False.
        pn_routing_protocol: 'ospf'                        # Routing protocol to configure. Choices are ['ebgp', 'ospf']
        pn_ospf_area_id: "{{ pn_ospf_area_id }}"           # Area id to configure for ospf. Default: 0
        pn_iospf_ip_range: "{{ pn_iospf_ip_range }}"       # Ip range for creating the interfaces between leaf clusters. Default:'75.75.75.0/24'
        pn_iospf_vlan: "{{ pn_iospf_vlan }}"               # Vlan for creating the interfaces between leaf clusters. Default:'4040'
      register: ospf_out                                   # Variable to hold/register output of the above tasks.
      until: ospf_out.failed != true                       # If the above code fails it will retry the code
      retries: 3                                           # This is the retries count
      delay: 1

    - pause:
        seconds: 2                                         # Pause playbook execution for specified amount of time.
